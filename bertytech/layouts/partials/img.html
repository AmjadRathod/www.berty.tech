{{ $layout := .layout | default "responsive" }}

{{- $canConvert := in (slice "jpg" "jpeg" "png") .src.MediaType.SubType -}}
{{- $mainImg := .src -}}
{{- if $canConvert -}}
    {{/*  Have to use resize to convert to webp. See issue: https://discourse.gohugo.io/t/image-conversion-without-resizing/32429  */}}
    {{- $mainImg = .src.Resize (printf "%sx webp" (string .width | default "500")) -}}
{{- end -}}

<amp-img
    class="{{ with .class }}{{.}}{{end}}"
    {{ with .title }}title="{{.}}"{{end}}
    {{ with .alt }}alt="{{.}}"{{end}}
    src="{{$mainImg.RelPermalink}}"
    {{ with .width }}width="{{.}}"{{end}}
    {{ with .height }}height="{{.}}"{{end}}
    layout="{{ $layout }}">
    <amp-img 
        fallback
        {{ with .title }}title="{{.}}"{{end}}
        {{ with .alt }}alt="{{.}}"{{end}}
        {{ with .src }}src="{{ .RelPermalink }}"{{end}}
        {{ with .width }}width="{{.}}"{{end}}
        {{ with .height }}height="{{.}}"{{end}}
        layout="{{ $layout }}">
    </amp-img>
</amp-img>
